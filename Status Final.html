<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Status">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#5E5CE6" id="theme-color-meta">
    
    <link rel="manifest" href='data:application/manifest+json,{"name":"Status Pro","short_name":"Status","display":"standalone","start_url":".","background_color":"#F2F2F7","theme_color":"#5E5CE6","icons":[{"src":"data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%2334C759%22><path d=%22M12 2L22 12L12 22L2 12L12 2z%22/></svg>","sizes":"192x192","type":"image/svg+xml"}]}'>

    <title>Status Pro</title>
    <style>
        :root {
            --app-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --purple-accent: rgb(94, 92, 230);
            
            --bg-gradient: linear-gradient(-45deg, #e0c3fc, #8ec5fc, #e0c3fc, #b2c8f8);
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.8);
            --glass-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            --text-main: #1C1C1E;
            --text-muted: #8E8E93;
            --card-bg: rgba(255, 255, 255, 0.8);
            --input-bg: rgba(255, 255, 255, 0.9);
            --input-border: rgba(0,0,0,0.05);
            --input-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
            --btn-text: #FFFFFF;
            --bar-bg: rgba(0,0,0,0.04);
            --bar-green: linear-gradient(90deg, #34C759, #28a745);
            --bar-orange: linear-gradient(90deg, #FF9500, #FF9F0A);
            --bar-red: linear-gradient(90deg, #FF3B30, #FF453A);
            --bar-ended: #E5E5EA;
            --action-btn-bg: rgba(0,0,0,0.05);
            --alarm-glow: rgba(255, 59, 48, 0.4);
        }

        [data-theme="dark"] {
            --bg-gradient: linear-gradient(-45deg, #1a1a2e, #16213e, #0f0f1a, #1a1a2e);
            --glass-bg: rgba(30, 30, 46, 0.65);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            --text-main: #F2F2F7;
            --text-muted: #A1A1A6;
            --card-bg: rgba(44, 44, 46, 0.8);
            --input-bg: rgba(28, 28, 30, 0.9);
            --input-border: rgba(255,255,255,0.05);
            --input-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
            --bar-bg: rgba(255,255,255,0.05);
            --bar-ended: #48484A;
            --action-btn-bg: rgba(255,255,255,0.1);
            --alarm-glow: rgba(255, 69, 58, 0.4);
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        * {
            box-sizing: border-box;
            transition: background-color 0.4s ease, color 0.4s ease, border-color 0.4s ease;
            -webkit-tap-highlight-color: transparent;
        }

        html, body { height: 100%; width: 100%; overscroll-behavior-y: none; }

        body {
            font-family: var(--app-font);
            background: var(--bg-gradient);
            background-size: 300% 300%;
            animation: gradientShift 15s ease infinite;
            color: var(--text-main);
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            padding: 2.5rem 1rem 8rem 1rem;
            margin: 0;
            user-select: none; -webkit-user-select: none;
        }

        .app-container {
            background: var(--glass-bg); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border); border-top: 1px solid rgba(255, 255, 255, 0.4); border-left: 1px solid rgba(255, 255, 255, 0.4);
            width: 100%; max-width: 480px; border-radius: 36px; box-shadow: var(--glass-shadow);
            padding: 2.5rem 2rem; display: flex; flex-direction: column; gap: 1.8rem; position: relative; height: fit-content;
        }

        @keyframes pulseGlow {
            0%, 100% { transform: scale(1); filter: drop-shadow(0 0 4px rgba(52, 199, 89, 0.3)); }
            50% { transform: scale(1.1); filter: drop-shadow(0 0 12px rgba(52, 199, 89, 0.8)); }
        }

        .top-diamond { display: flex; justify-content: center; margin-top: -10px; margin-bottom: -15px; }
        .top-diamond svg { animation: pulseGlow 4s ease-in-out infinite; }

        .header { display: flex; justify-content: space-between; align-items: center; min-height: 40px; }
        h1 { color: var(--text-main); margin: 0; font-size: 2.2rem; font-weight: 800; letter-spacing: -1px; position: absolute; left: 50%; transform: translateX(-50%); white-space: nowrap; }
        .header-actions { display: flex; z-index: 2; }
        .icon-btn { background: rgba(128, 128, 128, 0.08); color: var(--text-main); border: none; padding: 10px; border-radius: 14px; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .icon-btn:hover { background: rgba(128, 128, 128, 0.15); transform: scale(1.05); }

        .input-group { display: flex; flex-direction: column; gap: 14px; background: rgba(128,128,128,0.03); padding: 1.5rem; border-radius: 28px; border: 1px solid var(--glass-border); }
        
        input[type="text"], input[type="number"], select, textarea { 
            font-family: inherit; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-main); 
            padding: 16px; border-radius: 16px; font-size: 1.05rem; outline: none; width: 100%; 
            box-shadow: var(--input-shadow); transition: all 0.3s ease; user-select: auto; -webkit-user-select: auto;
        }
        
        textarea { resize: vertical; min-height: 80px; }
        
        input:focus, select:focus, textarea:focus { 
            border-color: var(--purple-accent); box-shadow: 0 0 0 3px rgba(94, 92, 230, 0.2), var(--input-shadow); transform: translateY(-1px); 
        }
        
        .time-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        button.create-btn { background: var(--purple-accent); color: var(--btn-text); border: none; padding: 18px; border-radius: 18px; font-size: 1.1rem; font-weight: 700; letter-spacing: 0.5px; cursor: pointer; width: 100%; margin-top: 10px; box-shadow: 0 10px 20px -5px rgba(94, 92, 230, 0.4); transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        button.create-btn:active { transform: scale(0.97); box-shadow: 0 5px 10px -5px rgba(94, 92, 230, 0.4); }

        @keyframes slideIn { 0% { opacity: 0; transform: translateY(-15px) scale(0.98); } 100% { opacity: 1; transform: translateY(0) scale(1); } }
        #status-list { display: flex; flex-direction: column; gap: 16px; }
        .status-item { background: var(--card-bg); border-radius: 24px; padding: 1.5rem; display: flex; flex-direction: column; gap: 14px; border: 1px solid var(--glass-border); box-shadow: 0 8px 16px -4px rgba(0,0,0,0.05); animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; position: relative; overflow: hidden; }
        .status-header { display: flex; justify-content: space-between; align-items: center; }
        .status-title { font-weight: 800; font-size: 1.15rem; color: var(--text-main); letter-spacing: -0.3px; flex: 1; overflow: hidden; text-overflow: ellipsis; }
        
        .progress-container { width: 100%; background: var(--bar-bg); height: 14px; border-radius: 999px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
        .progress-fill { height: 100%; background: var(--bar-green); width: 100%; border-radius: 999px; transition: width 1s linear, background 0.5s ease; }
        .progress-fill.warning { background: var(--bar-orange); }
        .progress-fill.danger { background: var(--bar-red); }
        .progress-fill.ended { background: var(--bar-ended); }
        
        .status-footer { display: flex; justify-content: center; align-items: center; margin-top: -2px; }
        .status-time { font-weight: 800; font-size: 1.3rem; color: var(--purple-accent); font-variant-numeric: tabular-nums; background: rgba(128, 128, 128, 0.08); padding: 6px 16px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        
        /* New Action Buttons Styling */
        .action-btns { display: flex; gap: 8px; }
        .reset-btn, .remove-btn { 
            background: var(--action-btn-bg); color: var(--text-muted); border: none; padding: 8px; 
            border-radius: 50%; width: 34px; height: 34px; display: flex; align-items: center; 
            justify-content: center; cursor: pointer; transition: all 0.2s; font-size: 1.1rem;
        }
        .reset-btn:hover { background: #007AFF; color: white; transform: scale(1.1) rotate(180deg); }
        .remove-btn:hover { background: #FF3B30; color: white; transform: scale(1.1) rotate(90deg); }

        .luck-section { margin-top: 1rem; display: flex; flex-direction: column; align-items: center; gap: 12px; padding-top: 1.5rem; border-top: 1px solid var(--glass-border); }
        .luck-btn { background: transparent; border: none; font-size: 3.5rem; cursor: pointer; padding: 0; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); filter: drop-shadow(0 10px 15px rgba(0,0,0,0.15)); }
        .luck-btn:hover { transform: translateY(-5px) scale(1.1); filter: drop-shadow(0 15px 20px rgba(0,0,0,0.25)); }
        .luck-btn:active { transform: scale(0.9); }
        .luck-output { font-weight: 800; font-size: 1.25rem; min-height: 1.5rem; text-align: center; color: var(--purple-accent); }

        .bottom-dock { display: flex; gap: 20px; background: var(--glass-bg); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid var(--glass-border); border-top: 1px solid rgba(255, 255, 255, 0.4); padding: 12px 24px; border-radius: 999px; box-shadow: var(--glass-shadow); margin-top: 1.5rem; z-index: 100; }
        .dock-btn { background: rgba(128, 128, 128, 0.08); color: var(--text-main); border: none; padding: 12px; border-radius: 50%; width: 48px; height: 48px; font-size: 1.3rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .dock-btn:hover { background: rgba(128, 128, 128, 0.15); transform: translateY(-4px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); }
        .notify-btn { color: var(--purple-accent); }
        .notify-btn.granted { color: #34C759; cursor: default; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; z-index: 9999; opacity: 0; pointer-events: none; transition: opacity 0.4s ease; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .settings-card { background: var(--card-bg); width: 90%; max-width: 420px; border-radius: 32px; padding: 2.5rem; box-shadow: 0 30px 60px rgba(0,0,0,0.4); display: flex; flex-direction: column; gap: 24px; transform: translateY(20px); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); border: 1px solid var(--glass-border); }
        .modal-overlay.active .settings-card { transform: translateY(0); }
        .settings-header { display: flex; justify-content: space-between; align-items: center; font-weight: 800; font-size: 1.6rem; letter-spacing: -0.5px;}
        .close-btn { background: var(--action-btn-bg); border: none; border-radius: 50%; width: 36px; height: 36px; cursor: pointer; color: var(--text-main); font-size: 1.2rem; transition: transform 0.2s; }
        .close-btn:hover { transform: scale(1.1); }
        .setting-group { display: flex; flex-direction: column; gap: 10px; }
        .setting-group label { font-weight: 700; font-size: 0.95rem; color: var(--text-muted); }
        .slider-row { display: flex; align-items: center; gap: 12px; }
        .slider-row span { width: 18px; font-weight: 800; font-size: 1.1rem; }
        .slider-row span.r { color: #FF3B30; }
        .slider-row span.g { color: #34C759; }
        .slider-row span.b { color: #007AFF; }
        input[type="range"] { flex: 1; -webkit-appearance: none; height: 8px; border-radius: 6px; background: rgba(128,128,128,0.2); outline: none; box-shadow: var(--input-shadow); }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; border-radius: 50%; background: var(--text-main); cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3); transition: transform 0.1s; }
        input[type="range"]::-webkit-slider-thumb:active { transform: scale(1.2); }
        .color-preview { width: 100%; height: 48px; border-radius: 16px; background: var(--purple-accent); margin-top: 12px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }

        /* --- Constant Alarm Overlay & Details --- */
        @keyframes alarmFlash {
            0%, 100% { box-shadow: inset 0 0 0 0px var(--alarm-glow); background: rgba(0,0,0,0.7); }
            50% { box-shadow: inset 0 0 0 20px var(--alarm-glow); background: rgba(0,0,0,0.85); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .alarm-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            z-index: 10000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }

        .alarm-overlay.active {
            opacity: 1; pointer-events: auto;
            animation: alarmFlash 1.5s infinite;
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        }

        .alarm-card {
            background: var(--card-bg); width: 90%; max-width: 400px;
            border-radius: 32px; padding: 3rem 2rem; box-shadow: 0 40px 80px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; align-items: center; gap: 20px; text-align: center;
            border: 2px solid #FF3B30;
        }

        .alarm-overlay.active .alarm-card { animation: shake 0.5s ease-in-out; }

        .alarm-title-header { font-size: 1.5rem; font-weight: 800; color: #FF3B30; margin: 0; letter-spacing: -0.5px; }

        .details-container { display: flex; flex-direction: column; align-items: center; width: 100%; margin: 5px 0; }
        .details-btn { background: none; border: none; color: var(--text-muted); font-weight: 700; font-size: 1.05rem; cursor: pointer; padding: 8px 16px; border-radius: 12px; transition: background 0.2s, color 0.2s; }
        .details-btn:hover { background: rgba(128,128,128,0.1); color: var(--text-main); }
        .details-content { max-height: 0; overflow: hidden; opacity: 0; width: 100%; transition: max-height 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.4s ease, margin 0.4s ease; font-size: 1.05rem; font-weight: 600; color: var(--text-main); line-height: 1.5; text-align: center; word-wrap: break-word; white-space: pre-wrap; }
        .details-content.expanded { max-height: 300px; opacity: 1; margin-top: 12px; }
        
        .stop-alarm-btn {
            background: linear-gradient(135deg, #FF3B30, #FF453A); color: white; border: none; padding: 18px 36px; border-radius: 20px;
            font-size: 1.3rem; font-weight: 800; cursor: pointer; width: 100%; box-shadow: 0 10px 20px -5px rgba(255, 59, 48, 0.5);
            transition: transform 0.2s; letter-spacing: -0.5px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .stop-alarm-btn:active { transform: scale(0.95); }

    </style>
</head>
<body>

    <div class="app-container">
        <div class="top-diamond">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="#34C759" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L22 12L12 22L2 12L12 2z"/>
            </svg>
        </div>

        <div class="header">
            <div class="header-actions">
                <button class="icon-btn" onclick="toggleFullScreen()" title="Full Screen">‚õ∂</button>
            </div>
            <h1>Status</h1>
            <div style="width: 44px;"></div>
        </div>
        
        <div class="input-group">
            <input type="text" id="title-input" placeholder="What's your next focus?">
            <textarea id="desc-input" placeholder="Add a hidden description/note..."></textarea>
            
            <div class="time-inputs">
                <input type="number" id="days-input" placeholder="Days" min="0">
                <input type="number" id="hours-input" placeholder="Hours" min="0">
                <input type="number" id="min-input" placeholder="Mins" min="0" max="59">
                <input type="number" id="sec-input" placeholder="Secs" min="0" max="59">
            </div>
            <button class="create-btn" onclick="addNewStatus()">Update</button>
        </div>

        <div id="status-list"></div>

        <div class="luck-section">
            <button class="luck-btn" onclick="checkLuck()">üîÆ</button>
            <div id="luck-output" class="luck-output"></div>
        </div>
    </div>

    <div class="bottom-dock">
        <button class="dock-btn" onclick="toggleSettings()">‚öôÔ∏è</button>
        <button class="dock-btn" id="theme-btn" onclick="toggleTheme()">üåô</button>
        <button class="dock-btn notify-btn" id="notify-btn" onclick="requestNotificationPermission()">üîî</button>
    </div>

    <div class="modal-overlay" id="settings-modal">
        <div class="settings-card">
            <div class="settings-header">
                Settings
                <button class="close-btn" onclick="toggleSettings()">‚úï</button>
            </div>
            
            <div class="setting-group">
                <label>App Font</label>
                <select id="font-select" onchange="updateFont()">
                    <option value='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'>System Default (Sleek)</option>
                    <option value='"SF Pro Rounded", "Nunito", sans-serif'>Rounded (Friendly)</option>
                    <option value='"Courier New", Courier, monospace'>Monospace (Coding)</option>
                    <option value='Georgia, serif'>Serif (Classic)</option>
                </select>
            </div>

            <div class="setting-group">
                <label>Custom Interface Color (RGB)</label>
                <div class="slider-row"><span class="r">R</span><input type="range" id="red-slider" min="0" max="255" value="94" oninput="updateColor()"></div>
                <div class="slider-row"><span class="g">G</span><input type="range" id="green-slider" min="0" max="255" value="92" oninput="updateColor()"></div>
                <div class="slider-row"><span class="b">B</span><input type="range" id="blue-slider" min="0" max="255" value="230" oninput="updateColor()"></div>
                <div class="color-preview" id="color-preview"></div>
            </div>
        </div>
    </div>

    <div class="alarm-overlay" id="alarm-overlay">
        <div class="alarm-card">
            <h2 class="alarm-title-header">Time's Up!</h2>
            
            <div class="details-container" id="alarm-details-container" style="display: none;">
                <button class="details-btn" id="details-toggle-btn" onclick="toggleDetails()">Details ‚ñº</button>
                <div class="details-content" id="alarm-desc"></div>
            </div>

            <button class="stop-alarm-btn" id="stop-alarm-btn" onclick="stopAlarm()">Stop Alarm</button>
        </div>
    </div>

    <script>
        // --- Persistence Engine ---
        try {
            const savedTheme = localStorage.getItem('status-theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.getElementById('theme-btn').innerText = savedTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';

            const savedFont = localStorage.getItem('status-font');
            if (savedFont) {
                document.documentElement.style.setProperty('--app-font', savedFont);
                document.getElementById('font-select').value = savedFont;
            }

            const savedR = localStorage.getItem('status-r');
            const savedG = localStorage.getItem('status-g');
            const savedB = localStorage.getItem('status-b');
            
            if (savedR && savedG && savedB) {
                document.getElementById('red-slider').value = savedR;
                document.getElementById('green-slider').value = savedG;
                document.getElementById('blue-slider').value = savedB;
                const newColor = `rgb(${savedR}, ${savedG}, ${savedB})`;
                document.documentElement.style.setProperty('--purple-accent', newColor);
                document.getElementById('color-preview').style.background = newColor;
                document.getElementById('theme-color-meta').setAttribute('content', newColor);
            }

            if ("Notification" in window && Notification.permission === "granted") {
                document.getElementById('notify-btn').classList.add("granted");
            }
        } catch (e) { console.warn("Local storage blocked.", e); }

        // --- Settings Logic ---
        function toggleSettings() { document.getElementById('settings-modal').classList.toggle('active'); }
        function updateFont() { const font = document.getElementById('font-select').value; document.documentElement.style.setProperty('--app-font', font); try { localStorage.setItem('status-font', font); } catch(e){} }
        function updateColor() {
            const r = document.getElementById('red-slider').value; const g = document.getElementById('green-slider').value; const b = document.getElementById('blue-slider').value;
            const newColor = `rgb(${r}, ${g}, ${b})`;
            document.documentElement.style.setProperty('--purple-accent', newColor); document.getElementById('color-preview').style.background = newColor; document.getElementById('theme-color-meta').setAttribute('content', newColor); 
            try { localStorage.setItem('status-r', r); localStorage.setItem('status-g', g); localStorage.setItem('status-b', b); } catch(e){}
        }
        function toggleTheme() {
            const newTheme = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            document.getElementById('theme-btn').innerText = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            try { localStorage.setItem('status-theme', newTheme); } catch(e){}
        }
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
                else if (document.documentElement.webkitRequestFullscreen) document.documentElement.webkitRequestFullscreen();
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
            }
        }

        // --- Advanced Timer Engine ---
        let statuses = [];
        let statusIdCounter = 0;
        let activeAlarms = [];

        function saveTimers() {
            try {
                const timersToSave = statuses.map(s => ({
                    id: s.id, title: s.title, description: s.description, totalSeconds: s.totalSeconds, endTime: s.endTime, alarmed: s.alarmed 
                }));
                localStorage.setItem('status-timers', JSON.stringify(timersToSave));
            } catch(e){}
        }

        try {
            const savedTimers = localStorage.getItem('status-timers');
            if (savedTimers) {
                const parsed = JSON.parse(savedTimers);
                parsed.forEach(timer => {
                    const now = Date.now();
                    const remaining = Math.round((timer.endTime - now) / 1000);
                    
                    const newStatus = {
                        id: timer.id, title: timer.title, description: timer.description || "", totalSeconds: timer.totalSeconds,
                        endTime: timer.endTime, remainingSeconds: remaining > 0 ? remaining : 0, interval: null, alarmed: timer.alarmed || false
                    };
                    
                    statusIdCounter = Math.max(statusIdCounter, timer.id + 1);
                    statuses.push(newStatus);
                    
                    if(newStatus.remainingSeconds > 0) startTimer(newStatus);
                    else if (!newStatus.alarmed) triggerConstantAlarm(newStatus);
                });
                renderStatuses();
            }
        } catch(e){}

        function requestNotificationPermission() {
            if ("Notification" in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") document.getElementById('notify-btn').classList.add("granted");
                });
            }
        }

        function addNewStatus() {
            const titleInput = document.getElementById('title-input');
            const descInput = document.getElementById('desc-input');
            
            const daysInput = document.getElementById('days-input');
            const hoursInput = document.getElementById('hours-input');
            const minInput = document.getElementById('min-input');
            const secInput = document.getElementById('sec-input');

            const title = titleInput.value.trim() || "Focused Session";
            const description = descInput.value.trim();
            
            const d = parseInt(daysInput.value) || 0;
            const h = parseInt(hoursInput.value) || 0;
            const m = parseInt(minInput.value) || 0;
            const s = parseInt(secInput.value) || 0;

            const totalSeconds = (d * 86400) + (h * 3600) + (m * 60) + s;

            if (totalSeconds <= 0) return alert("Please enter a valid time.");

            const newStatus = { 
                id: statusIdCounter++, title, description, totalSeconds, 
                remainingSeconds: totalSeconds, endTime: Date.now() + (totalSeconds * 1000), 
                interval: null, alarmed: false
            };
            
            statuses.push(newStatus);
            saveTimers(); renderStatuses(); startTimer(newStatus);

            titleInput.value = ''; descInput.value = ''; daysInput.value = ''; hoursInput.value = ''; minInput.value = ''; secInput.value = '';
        }

        function startTimer(status) {
            // Ensure any previous interval is cleared before starting a new one
            if(status.interval) clearInterval(status.interval);
            
            status.interval = setInterval(() => {
                const now = Date.now();
                status.remainingSeconds = Math.round((status.endTime - now) / 1000);

                if (status.remainingSeconds <= 0) {
                    clearInterval(status.interval);
                    status.remainingSeconds = 0;
                    
                    if (!status.alarmed) {
                        triggerConstantAlarm(status);
                    }
                }
                updateStatusUI(status);
            }, 1000);
        }

        // --- NEW: Reset Timer Feature ---
        function resetStatus(id) {
            const index = statuses.findIndex(s => s.id === id);
            if (index > -1) {
                const status = statuses[index];
                
                // Stop the current countdown
                if(status.interval) clearInterval(status.interval);
                
                // Recalculate the absolute end time from now
                status.endTime = Date.now() + (status.totalSeconds * 1000);
                status.remainingSeconds = status.totalSeconds;
                status.alarmed = false; // Reset the alarm flag so it can ring again
                
                saveTimers(); 
                updateStatusUI(status); // Snap the UI back to full instantly
                startTimer(status); // Restart the clock
            }
        }

        function removeStatus(id) {
            const index = statuses.findIndex(s => s.id === id);
            if (index > -1) { clearInterval(statuses[index].interval); statuses.splice(index, 1); saveTimers(); renderStatuses(); }
        }

        // --- Expandable Alarm System ---
        function triggerConstantAlarm(status) {
            status.alarmed = true;
            saveTimers();
            activeAlarms.push(status.id);

            document.getElementById('stop-alarm-btn').innerText = status.title;
            
            const detailsContainer = document.getElementById('alarm-details-container');
            const descEl = document.getElementById('alarm-desc');

            if (status.description && status.description.trim() !== "") {
                detailsContainer.style.display = 'flex';
                descEl.innerText = status.description;
            } else {
                detailsContainer.style.display = 'none';
            }
            
            document.getElementById('alarm-overlay').classList.add('active');

            if ("Notification" in window && Notification.permission === "granted") {
                new Notification(status.title, { 
                    body: status.description || "Your timer has finished.",
                    requireInteraction: true 
                });
            }
        }

        function toggleDetails() {
            const content = document.getElementById('alarm-desc');
            const btn = document.getElementById('details-toggle-btn');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                btn.innerText = 'Details ‚ñº';
            } else {
                content.classList.add('expanded');
                btn.innerText = 'Details ‚ñ≤';
            }
        }

        function stopAlarm() {
            document.getElementById('alarm-overlay').classList.remove('active');
            activeAlarms = [];
            
            setTimeout(() => {
                document.getElementById('alarm-desc').classList.remove('expanded');
                document.getElementById('details-toggle-btn').innerText = 'Details ‚ñº';
            }, 300); 
        }

        function formatTime(totalSeconds) {
            const d = Math.floor(totalSeconds / 86400);
            const h = Math.floor((totalSeconds % 86400) / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = totalSeconds % 60;
            
            let timeString = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            if (d > 0) timeString = `${d}d ` + timeString; 
            
            return timeString;
        }

        function renderStatuses() {
            const list = document.getElementById('status-list');
            list.innerHTML = '';
            statuses.forEach(status => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'status-item';
                itemDiv.id = `status-${status.id}`;
                
                // Added the new Reset Button into the header next to the remove button
                itemDiv.innerHTML = `
                    <div class="status-header">
                        <div class="status-title" title="${status.title}">${status.title}</div>
                        <div class="action-btns">
                            <button class="reset-btn" onclick="resetStatus(${status.id})" title="Reset Timer">‚ü≥</button>
                            <button class="remove-btn" onclick="removeStatus(${status.id})" title="Delete">‚úï</button>
                        </div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-fill" id="bar-${status.id}" style="width: 100%"></div>
                    </div>
                    <div class="status-footer">
                        <span class="status-time" id="time-${status.id}">${formatTime(status.remainingSeconds)}</span>
                    </div>
                `;
                list.appendChild(itemDiv);
                updateStatusUI(status); 
            });
        }

        function updateStatusUI(status) {
            const timeEl = document.getElementById(`time-${status.id}`);
            const barEl = document.getElementById(`bar-${status.id}`);
            if (timeEl && barEl) {
                timeEl.innerText = formatTime(status.remainingSeconds);
                const percentage = (status.remainingSeconds / status.totalSeconds) * 100;
                barEl.style.width = `${percentage}%`;
                barEl.className = 'progress-fill'; 
                if (status.remainingSeconds <= 0) barEl.classList.add('ended');
                else if (percentage < 20) barEl.classList.add('danger'); 
                else if (percentage < 50) barEl.classList.add('warning'); 
            }
        }

        const luckPhrases = [
            "Good", "Bad", "I'd be careful", "Outlook is excellent", "Don't count on it", "Absolutely", "Very doubtful", 
            "Proceed with caution", "The stars align", "Better not tell you now", "Ask again later", "Looks promising", 
            "Not looking great", "Signs point to yes", "My sources say no", "Take a risk", "Play it safe today", 
            "Luck is on your side", "Tread lightly", "Without a doubt", "It is decidedly so", "Focus and try again", 
            "A pleasant surprise awaits", "Expect the unexpected"
        ];

        function checkLuck() {
            const output = document.getElementById('luck-output');
            output.style.opacity = '0';
            setTimeout(() => {
                output.innerText = luckPhrases[Math.floor(Math.random() * luckPhrases.length)];
                output.style.opacity = '1';
                output.style.transform = "scale(1.1)";
                setTimeout(() => { output.style.transform = "scale(1)"; }, 150);
            }, 150);
        }
    </script>
</body>
</html>
